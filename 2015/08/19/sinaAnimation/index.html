<!DOCTYPE html>
<html lang=en>
<head>
    <meta charset="utf-8">
    
    <title>一句代码添加新浪弹出框动画. | Hongbo Bi’s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="新浪微博中的“加号按钮”点击后的弹出动画很有意思，每当一个人孤单寂寞冷的时候总会不停的点这个动画，终于忍不住自己撸了一个。废话不多说，直接上效果图：">
<meta property="og:type" content="article">
<meta property="og:title" content="一句代码添加新浪弹出框动画.">
<meta property="og:url" content="http://bihongbo.com/2015/08/19/sinaAnimation/index.html">
<meta property="og:site_name" content="Hongbo Bi’s Blog">
<meta property="og:description" content="新浪微博中的“加号按钮”点击后的弹出动画很有意思，每当一个人孤单寂寞冷的时候总会不停的点这个动画，终于忍不住自己撸了一个。废话不多说，直接上效果图：">
<meta property="og:image" content="http://7xkdhe.com1.z0.glb.clouddn.com/sinaAnimation1.gif">
<meta property="og:updated_time" content="2016-03-28T04:24:37.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="一句代码添加新浪弹出框动画.">
<meta name="twitter:description" content="新浪微博中的“加号按钮”点击后的弹出动画很有意思，每当一个人孤单寂寞冷的时候总会不停的点这个动画，终于忍不住自己撸了一个。废话不多说，直接上效果图：">
    

    

    
        <link rel="icon" href="/css/images/favicon.ico# path to favicon" />
    

    <link rel="stylesheet" href="/vendor/font-awesome/css/font-awesome.min.css" type="text/css">
    <link rel="stylesheet" href="/vendor/open-sans/styles.css" type="text/css">
    <link rel="stylesheet" href="/vendor/source-code-pro/styles.css" type="text/css">

    <link rel="stylesheet" href="/css/style.css" type="text/css">

    <script src="/vendor/jquery/2.1.3/jquery.min.js" type="text/javascript"></script>
    
    
        <link rel="stylesheet" href="/vendor/fancybox/jquery.fancybox.css" type="text/css">
    
    
    
    
        <script>
var _hmt = _hmt || [];
(function() {
    var hm = document.createElement("script");
    hm.src = "//hm.baidu.com/hm.js?bhbwudi18";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
})();
</script>

    

</head>
<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">Hongbo Bi’s Blog</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/.">Home</a>
                
                    <a class="main-nav-link" href="/archives">Archives</a>
                
                    <a class="main-nav-link" href="/categories">Categories</a>
                
                    <a class="main-nav-link" href="/tags">Tags</a>
                
            </nav>
            
                
                <nav id="sub-nav">
                    <div class="profile" id="profile-nav">
                        <a id="profile-anchor" href="javascript:;">
                            <img class="avatar" src="/css/images/avatar.png" />
                            <i class="fa fa-caret-down"></i>
                        </a>
                    </div>
                </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="st-default-search-input search-form-input" placeholder="Search" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <script type="text/javascript">
(function(w,d,t,u,n,s,e) {w['SwiftypeObject']=n;w[n]=w[n]||function() {
(w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
})(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

_st('install','PtetYTqdvpkd9wh99uMx','2.0.0');
</script>
<style>
    .st-ui-injected-overlay-container,
    .st-ui-injected-overlay-container *:not(select) {
        font-family: inherit !important;
    }
    section.st-ui-content.st-search-results a.st-ui-result .st-ui-type-heading {
        color: undefined !important;
    }
    .st-ui-injected-overlay-container .st-ui-header input[type="text"]:focus {
        border-bottom: 2px solid undefined;
    }
    .st-ui-injected-overlay-container .st-ui-footer a.st-ui-pagination-link {
        color: undefined;
    }
    .st-ui-injected-overlay-container .st-ui-footer a.st-ui-pagination-link span.st-ui-arrow {
        border-color: undefined;
    }
</style>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/.">Home</a></td>
                
                    <td><a class="main-nav-link" href="/archives">Archives</a></td>
                
                    <td><a class="main-nav-link" href="/categories">Categories</a></td>
                
                    <td><a class="main-nav-link" href="/tags">Tags</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="st-default-search-input search-form-input" placeholder="Search" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
                

<aside id="profile">
    <div class="inner profile-inner">
        <div class="base-info profile-block">
            <img id="avatar" src="/css/images/avatar.png" />
            <h2 id="name">毕洪博</h2>
            <h3 id="title">iOS Developer &amp; Pop Arter</h3>
            <span id="location"><i class="fa fa-map-marker"></i>Beijing Chaoyang, China</span>
            <a id="follow" target="_blank" href="https://github.com/bb-coder">FOLLOW</a>
        </div>
        <div class="article-info profile-block">
            <div class="article-info-block">
                14
                <span>posts</span>
            </div>
            <div class="article-info-block">
                5
                <span>tags</span>
            </div>
        </div>
        
        <div class="profile-block social-links">
            <table>
                <tr>
                    
                    <td><a href="http://github.com/bb-coder" target="_blank" title="github"><i class="fa fa-github"></i></a></td>
                    
                    <td><a href="http://weibo.com/bihongbo" target="_blank" title="weibo"><i class="fa fa-weibo"></i></a></td>
                    
                    <td><a href="https://twitter.com/HongboBi" target="_blank" title="twitter"><i class="fa fa-twitter"></i></a></td>
                    
                    <td><a href="/atom.xml" target="_blank" title="rss"><i class="fa fa-rss"></i></a></td>
                    
                </tr>
            </table>
        </div>
        
    </div>
</aside>

            
            <section id="main"><article id="post-sinaAnimation" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
            一句代码添加新浪弹出框动画.
        </h1>
    

                <div class="article-meta">
                    
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2015/08/19/sinaAnimation/">
            <time datetime="2015-08-19T06:07:33.000Z" itemprop="datePublished">2015-08-19</time>
        </a>
    </div>


                    
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/iOS/">iOS</a>
    </div>

                    
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/iOS/">iOS</a>
    </div>

                </div>
            </header>
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>新浪微博中的“加号按钮”点击后的弹出动画很有意思，每当一个人孤单寂寞冷的时候总会不停的点这个动画，终于忍不住自己撸了一个。废话不多说，直接上效果图：<br><img src="http://7xkdhe.com1.z0.glb.clouddn.com/sinaAnimation1.gif" alt="演示1"><br><a id="more"></a><br>首先说一下通过这个动画制作过程给大家分享的技术问题：<br>1.背景的毛玻璃效果<br>2.弹性动画<br>3.动画进行时对用户交互的处理<br>4.<code>UIControl</code> 的 <code>event</code> 类型</p>
<h1 id="一、背景的毛玻璃效果">一、背景的毛玻璃效果</h1><p>对新浪微博中弹出动画背景的思路分析：</p>
<p>  新浪的背景动画效果是有一个透明渐变的过程，并且最终渐变停止之后显示的是一个带有毛玻璃（半透明模糊）效果的视图。我的模仿思路是当准备要弹出动画的时候对整个视图进行截屏操作，将截屏后的图片进行毛玻璃效果渲染，然后在视图上加一个背景 <code>UIImageView</code> 来显示这张图片，然后通过 <code>alpha</code> 动画来由透明逐渐渐变出来。</p>
<h2 id="1-对视图进行截屏：">1.对视图进行截屏：</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UIGraphics</span> BeginImageContextWithOptions(size, <span class="literal">NO</span>, scale);</span><br><span class="line">[view<span class="variable">.layer</span> renderInContext:<span class="built_in">UIGraphicsGetCurrentContext</span>()];</span><br><span class="line"><span class="built_in">UIImage</span> * image = <span class="built_in">UIGraphicsGetImageFromCurrentImageContext</span>();</span><br></pre></td></tr></table></figure>
<h2 id="2-截屏后加上毛玻璃效果：">2.截屏后加上毛玻璃效果：</h2><p>制作毛玻璃效果有三种选择，一是 <code>iOS8</code> 后推出的 <code>UIBlurEffect</code> 和 <code>UIVisualEffectView</code> 来直接显示一个带有毛玻璃效果的 <code>View</code> 不过这种方式并不能直接生成一张带有毛玻璃效果的图片，而且它的模糊程度设置方法非常有限只有那几个枚举类型，无法满足需求。</p>
<p>第二种是通过 <code>CoreImage</code> 添加滤镜的方式来实现毛玻璃效果，不过这种方式有个缺点如果滤镜使用频繁会对主线程产生影响，如果我不断频繁的重复动画效果就必须要做判断看滤镜是否正在起作用，否则会经常出现崩溃和内存泄漏问题。</p>
<p>第三种我们使用苹果13年 <code>WWDC</code> 上发布的官方 <code>sample</code> 一个 <code>UIImage</code> 的分类 <code>UIImage+ImageEffects.h</code> ,它不但可以制作毛玻璃效果图片，而且可以调整模糊程度和颜色渲染。下面给出代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">image = [image bhb_applyBlurWithRadius:<span class="number">15</span> </span><br><span class="line">                             tintColor:tintColor </span><br><span class="line">                 saturationDeltaFactor:<span class="number">1</span> </span><br><span class="line">                             maskImage:<span class="literal">nil</span>];<span class="comment">//因为OC没有命名空间，避免你的程序中使用到了这个分类导致冲突，我加了前缀</span></span><br></pre></td></tr></table></figure>
<p>最终的显示效果很不错，我将模糊程度尽量的调节到与新浪微博一致了，不过在这个过程中，我发现当我频繁的进行弹出操作时，内存会不断攀升如下图：<br><img src="http://7xkdhe.com1.z0.glb.clouddn.com/sinaAnimation3.png" alt="演示3"><br>内存暴增的原因肯定是因为刚才的截图或者毛玻璃效果导致的，我们来用 <code>Instruments</code> 的 <code>Allocations</code> 来进行内存分析，找出元凶。<br>Xcode -&gt; Product -&gt; Profile -&gt; Allocations， 开启之后我们来使用右下角的 <code>Mark generation</code>（内存快照功能，进一步了解请移步<a href="http://www.ibm.com/developerworks/cn/mobile/mo-ios-memory/index.html" target="_blank" rel="external">这片文章</a>）<br><img src="http://7xkdhe.com1.z0.glb.clouddn.com/sinaAnimation4.png" alt="演示4"><br>在弹出 <code>View</code> 和移除 <code>View</code> 的两个时间点加 <code>Mark generation</code>。<br><img src="http://7xkdhe.com1.z0.glb.clouddn.com/sinaAnimation5.png" alt="演示5"><br>可以观察到，两个时间点竟然相差了4.31M，这是一个相当恐怖的数字，怪不得我点击几次弹出功能之后内存会暴增，让我们继续跟踪：<br><img src="http://7xkdhe.com1.z0.glb.clouddn.com/sinaAnimation6.png" alt="演示6"><br><img src="http://7xkdhe.com1.z0.glb.clouddn.com/sinaAnimation7.png" alt="演示7"><br><img src="http://7xkdhe.com1.z0.glb.clouddn.com/sinaAnimation8.png" alt="演示8"><br>跟踪到最后，我们发现大部分未释放的内存来自于绘图和位图的创建，回想我们当初做的截图操作，图片上下文开启后并没有进行关闭操作，所以在程序不断截图的过程中开启了无数的图片上下文而且不会被释放，添加下面这句关键的代码就可以解决问题（NC的我竟然连这个都忘了加-.-）：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UIGraphicsEndImageContext</span>();</span><br></pre></td></tr></table></figure>
<h1 id="二、弹性动画">二、弹性动画</h1><p>新浪动画中，按钮弹出的动画为弹性效果，按钮到达最终位置后不会直接停止，而是做类似弹簧的一种阻尼运动，要实现这种动画也很简单 <code>iOS7</code> 后苹果非常给力的添加了 <code>spring</code> 弹性动画的快速创建方式：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">UIView</span> animateWithDuration:(<span class="built_in">NSTimeInterval</span>) </span><br><span class="line">                      delay:(<span class="built_in">NSTimeInterval</span>) </span><br><span class="line">     usingSpringWithDamping:(<span class="built_in">CGFloat</span>) </span><br><span class="line">      initialSpringVelocity:(<span class="built_in">CGFloat</span>) </span><br><span class="line">                    options:(<span class="built_in">UIViewAnimationOptions</span>) </span><br><span class="line">                 animations:^&#123;&#125; </span><br><span class="line">                 completion:^(<span class="built_in">BOOL</span> finished) &#123;&#125;];</span><br></pre></td></tr></table></figure>
<p>通过对 <code>Damping</code> 阻力和 <code>Velocity</code> 初速度的设置可以实现弹性动画动画效果如下图：<br><img src="http://7xkdhe.com1.z0.glb.clouddn.com/threeballs.gif" alt="摘自MotionDesign"></p>
<p>当然实现弹性动画还可以使用<a href="http://www.jwilling.com" target="_blank" rel="external">Jonathan Willing</a>大大的 <code>JNWSpringAnimation</code> ,你可以像使用 <code>CABasicAnimation</code> 一样轻松的使用它，通过改变关键的3个属性 <code>Damping</code> 阻力， <code>stiffness</code> 硬直, <code>mass</code> 质量来改变弹性动画的效果代码如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">JNWSpringAnimation *scale = [JNWSpringAnimation</span><br><span class="line">animationWithKeyPath:<span class="string">@"transform.translation.x"</span>];</span><br><span class="line">scale<span class="variable">.damping</span> = <span class="number">7</span>;</span><br><span class="line">scale<span class="variable">.stiffness</span> = <span class="number">7</span>;</span><br><span class="line">scale<span class="variable">.mass</span> = <span class="number">1</span>;</span><br><span class="line">scale<span class="variable">.fromValue</span> = @(<span class="number">0</span>);</span><br><span class="line">scale<span class="variable">.toValue</span> = @(<span class="number">400</span>);</span><br><span class="line">[redBall<span class="variable">.layer</span> addAnimation:scale forKey:scale<span class="variable">.keyPath</span>];</span><br><span class="line">redBall<span class="variable">.transform</span> = <span class="built_in">CGAffineTransformMakeTranslation</span>(<span class="number">400</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>关键的三个属性对动画的影响如下图：<br><img src="http://7xkdhe.com1.z0.glb.clouddn.com/jnwdemo.gif" alt="摘自MotionDesign"></p>
<p>为了减轻项目对第三方框架的依赖，我使用了 <code>iOS7</code> 原生的 <code>spring</code> 动画，如果你想要兼容以前版本，替换成 <code>JNWSpringAnimation</code> 即可。回到新浪动画的制作，动画是6个按钮按照顺序依次出现和消失，并且点击 <code>more</code> 按钮后可以向左平移到第二屏幕，并且在第二屏幕点击 <code>叉号</code> 按钮动画会加在第二屏幕的6个按钮上。<br>效果如图：<br><img src="http://7xkdhe.com1.z0.glb.clouddn.com/sinaAnimation2.gif" alt="演示2"></p>
<p>对此我使用了一个 <code>UIScrollView</code> 来承载这些按钮，并声明2个数组用来保存所有的按钮和正在显示的按钮（在屏幕上，并且需要做动画）:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>,<span class="keyword">strong</span>) <span class="built_in">NSMutableArray</span> * visableArray;<span class="comment">//屏幕显示的按钮数组</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>,<span class="keyword">strong</span>) <span class="built_in">NSMutableArray</span> * itemsArray;<span class="comment">//所有按钮的数组</span></span><br></pre></td></tr></table></figure>
<p>这样我在给这些按钮加动画的时候就不会浪费性能，只把动画加在当前显示在屏幕的按钮上。动画依次按照一定的时间差来执行，解决的办法我是用的 <code>GCD</code> :</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">self</span><span class="variable">.visableArray</span> enumerateObjectsUsingBlock:^(<span class="keyword">id</span> obj, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> *stop) &#123;</span><br><span class="line">    BHBCustomBtn * btn = obj;</span><br><span class="line">    <span class="built_in">CGFloat</span> x = btn<span class="variable">.frame</span><span class="variable">.origin</span><span class="variable">.x</span>;</span><br><span class="line">    <span class="built_in">CGFloat</span> y = btn<span class="variable">.frame</span><span class="variable">.origin</span><span class="variable">.y</span>;</span><br><span class="line">    <span class="built_in">CGFloat</span> width = btn<span class="variable">.frame</span><span class="variable">.size</span><span class="variable">.width</span>;</span><br><span class="line">    <span class="built_in">CGFloat</span> height = btn<span class="variable">.frame</span><span class="variable">.size</span><span class="variable">.height</span>;</span><br><span class="line">    btn<span class="variable">.frame</span> = <span class="built_in">CGRectMake</span>(x, [<span class="built_in">UIScreen</span> mainScreen]<span class="variable">.bounds</span><span class="variable">.size</span><span class="variable">.height</span> + y - <span class="keyword">self</span><span class="variable">.frame</span><span class="variable">.origin</span><span class="variable">.y</span>, width, height);</span><br><span class="line">    btn<span class="variable">.alpha</span> = <span class="number">0.0</span>;</span><br><span class="line">    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(idx * <span class="number">0.03</span> * <span class="built_in">NSEC_PER_SEC</span>)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        [<span class="built_in">UIView</span> animateWithDuration:<span class="number">0.35</span> delay:<span class="number">0</span> usingSpringWithDamping:<span class="number">0.85</span> initialSpringVelocity:<span class="number">25</span> options:<span class="built_in">UIViewAnimationOptionCurveEaseIn</span> animations:^&#123;</span><br><span class="line">            btn<span class="variable">.alpha</span> = <span class="number">1</span>;</span><br><span class="line">            btn<span class="variable">.frame</span> = <span class="built_in">CGRectMake</span>(x, y, width, height);</span><br><span class="line">        &#125; completion:^(<span class="built_in">BOOL</span> finished) &#123;</span><br><span class="line">            <span class="keyword">if</span> ([btn isEqual:[<span class="keyword">self</span><span class="variable">.visableArray</span> lastObject]]) &#123;</span><br><span class="line">                <span class="keyword">self</span><span class="variable">.superview</span><span class="variable">.superview</span><span class="variable">.userInteractionEnabled</span> = <span class="literal">YES</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<p>这样按钮就会依次以弹性动画的形式弹动出来了，是不是很简单，对于动画结束后所作的处理我将在下一节中说明。</p>
<h1 id="三、动画进行时对用户交互的处理">三、动画进行时对用户交互的处理</h1><p>动画过程中，处理用户交互的问题相当关键，视图动画中默认自动停止响应用户交互，因此当按钮进行弹性动画时，触摸它并不会生成任何事件。<br>但是当你触摸加号按钮的时候，会再次进行弹出框动画，这时就会弹出两个弹出框，这是我们不希望看到的，我们可以将加号按钮的 <code>enable</code> 属性设置为 <code>YES</code> 但是这样做我们要在封装的视图内部获取外部的加号按钮，这一点违背了封装性原则，并不是一个好的设计。所以我在所有按钮的弹性动画开始时，设置：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self</span><span class="variable">.superview</span><span class="variable">.superview</span><span class="variable">.userInteractionEnabled</span> = <span class="literal">NO</span>;</span><br></pre></td></tr></table></figure>
<p>注意视图的层级关系，我所设计的 <code>BHBPopView</code> 内部装着一个 <code>UIScrollView</code>，而它上面放着这些按钮，所以你要找到父视图的父视图才能够统一屏蔽用户的交互行为，当所有的按钮弹性动画结束时，也就是 <code>visableArray</code> 数组最后一个按钮动画结束时，我们恢复用户的交互：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self</span><span class="variable">.superview</span><span class="variable">.superview</span><span class="variable">.userInteractionEnabled</span> = <span class="literal">YES</span>;</span><br></pre></td></tr></table></figure>
<p>这样当动画进行过程中，屏蔽了用户的交互，避免发生一些意外的情况。</p>
<h1 id="四、UIControl_的_event_类型">四、<code>UIControl</code> 的 <code>event</code> 类型</h1><p>注意到新浪动画里面按钮有一个放大效果，并且当你手指放上去的时候放大，手指稍微挪动，便恢复原始大小。让我们先来看一下动画：</p>
<p><img src="http://7xkdhe.com1.z0.glb.clouddn.com/sinaAnimation9.gif" alt="演示9"></p>
<p>要实现这个效果只需要做一个形变动画就可以了，关键是我们如何控制它放大和恢复大小。<br>思路如下：按钮是继承自 <code>UIControl</code> ，<code>UIControl</code> 有不同的事件状态：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UIControlEventTouchDown</span>           = <span class="number">1</span> &lt;&lt;  <span class="number">0</span>,      <span class="comment">// 手指落在按钮的一瞬间触发</span></span><br><span class="line"><span class="built_in">UIControlEventTouchDownRepeat</span>     = <span class="number">1</span> &lt;&lt;  <span class="number">1</span>,      <span class="comment">// 多点触碰的时候，当第二根以上的手指触摸瞬间出发</span></span><br><span class="line"><span class="built_in">UIControlEventTouchDragInside</span>     = <span class="number">1</span> &lt;&lt;  <span class="number">2</span>,      <span class="comment">// 手指在视图范围内拖动触发</span></span><br><span class="line"><span class="built_in">UIControlEventTouchDragOutside</span>    = <span class="number">1</span> &lt;&lt;  <span class="number">3</span>,      <span class="comment">// 手指在视图范围外拖动触发</span></span><br><span class="line"><span class="built_in">UIControlEventTouchDragEnter</span>      = <span class="number">1</span> &lt;&lt;  <span class="number">4</span>,      <span class="comment">// 手指从视图外拖动到视图内时触发</span></span><br><span class="line"><span class="built_in">UIControlEventTouchDragExit</span>       = <span class="number">1</span> &lt;&lt;  <span class="number">5</span>,      <span class="comment">// 手指从视图内部拖动到视图外时触发</span></span><br><span class="line"><span class="built_in">UIControlEventTouchUpInside</span>       = <span class="number">1</span> &lt;&lt;  <span class="number">6</span>,      <span class="comment">// 手指在视图内部抬起时触发</span></span><br><span class="line"><span class="built_in">UIControlEventTouchUpOutside</span>      = <span class="number">1</span> &lt;&lt;  <span class="number">7</span>,      <span class="comment">// 手指在视图外部抬起时触发</span></span><br><span class="line"><span class="built_in">UIControlEventTouchCancel</span>         = <span class="number">1</span> &lt;&lt;  <span class="number">8</span>,      <span class="comment">// 取消事件，放上了太多手指或者被上锁或者电话呼叫打断。</span></span><br><span class="line"><span class="built_in">UIControlEventValueChanged</span>        = <span class="number">1</span> &lt;&lt; <span class="number">12</span>,      <span class="comment">// 当视图的值发生改变时，发送通知。</span></span><br><span class="line"><span class="built_in">UIControlEventEditingDidBegin</span>     = <span class="number">1</span> &lt;&lt; <span class="number">16</span>,     <span class="comment">// UITextField</span></span><br><span class="line"><span class="built_in">UIControlEventEditingChanged</span>      = <span class="number">1</span> &lt;&lt; <span class="number">17</span>,</span><br><span class="line"><span class="built_in">UIControlEventEditingDidEnd</span>       = <span class="number">1</span> &lt;&lt; <span class="number">18</span>,</span><br><span class="line"><span class="built_in">UIControlEventEditingDidEndOnExit</span> = <span class="number">1</span> &lt;&lt; <span class="number">19</span>,     <span class="comment">// 'return key' ending editing</span></span><br><span class="line"><span class="built_in">UIControlEventAllTouchEvents</span>      = <span class="number">0x00000FFF</span>,  <span class="comment">// for touch events</span></span><br><span class="line"><span class="built_in">UIControlEventAllEditingEvents</span>    = <span class="number">0x000F0000</span>,  <span class="comment">// for UITextField</span></span><br><span class="line"><span class="built_in">UIControlEventApplicationReserved</span> = <span class="number">0x0F000000</span>,  <span class="comment">// range available for application use</span></span><br><span class="line"><span class="built_in">UIControlEventSystemReserved</span>      = <span class="number">0xF0000000</span>,  <span class="comment">// range reserved for internal framework use</span></span><br><span class="line"><span class="built_in">UIControlEventAllEvents</span>           = <span class="number">0xFFFFFFFF</span></span><br></pre></td></tr></table></figure>
<p>我们所用到的事件是 <code>TouchDown</code> 和 <code>DragInside</code>，手指放上去触发 <code>TouchDown</code> 放大视图，在视图内部移动 <code>DragInside</code> 时恢复视图，注意按钮的作用范围是整个矩形区域包含了图片和文字，当你的手指移出图片的时候并非一定会移出按钮作用范围，所以依然会触发 <code>TouchUpInsite</code> 事件，这时候我们需要做一个属性来记录用户拖拽之后取消按钮的 <code>TouchUpInsite</code> 执行。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>,<span class="keyword">assign</span>) <span class="built_in">BOOL</span> btnCanceled;</span><br></pre></td></tr></table></figure>
<p>这样我们就可以实现动画效果了，具体代码如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//处理按钮有效的点击事件，当前按钮放大消失，其他按钮缩小消失，回调点击事件</span></span><br><span class="line">[btn addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(didClickBtn:) forControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>];</span><br><span class="line"><span class="comment">//处理手指按下事件，放大按钮</span></span><br><span class="line">[btn addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(didTouchBtn:) forControlEvents:<span class="built_in">UIControlEventTouchDown</span>];</span><br><span class="line"><span class="comment">//处理手指拖动事件，恢复按钮大小</span></span><br><span class="line">[btn addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(didCancelBtn:) forControlEvents:<span class="built_in">UIControlEventTouchDragInside</span>];</span><br></pre></td></tr></table></figure>
<h1 id="总结：">总结：</h1><p>制作类似新浪微博这种弹出框动画，我的思路是先分析逻辑，这些特效都由哪些组成，毛玻璃背景，加顶部一个 <code>logo</code> ，加中间 <code>UIScrollView</code>和上面的很多按钮,加底部工具条。研究透彻动画的执行顺序，动画执行结果有哪些分支。然后针对特效中的难点，比如毛玻璃，按钮弹性动画等等进行逐一研究攻破，最后将这些组件整合在一起变成一个好玩的动画，最后不要忘了动画的内存和性能测试。这次我模仿的新浪微博动画弹性效果并不是太理想，比起新浪原生来说不是特别一致，也希望有兴趣的你来给我一些建议优化它。最终在你的项目中加入我的弹出框动画真的只需要一句话哦：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">*  直接显示一个popView在某个view上</span><br><span class="line">*</span><br><span class="line">*  @param view       父view</span><br><span class="line">*  @param imageArray 图标数组</span><br><span class="line">*  @param titles     标题数组</span><br><span class="line">*  @param block      回调</span><br><span class="line">*  @return pop视图</span><br><span class="line">*/</span></span><br><span class="line">+ (BHB_I<span class="built_in">NSTANCETYPE</span>)showToView:(<span class="built_in">UIView</span> *)view andImages:(<span class="built_in">NSArray</span> *)imageArray andTitles:(<span class="built_in">NSArray</span> *)titles andSelectBlock:(DidSelectItemBlock)block;</span><br><span class="line"><span class="comment">/**</span><br><span class="line">*  如果显示一个带more功能的，请使用此方法</span><br><span class="line">*</span><br><span class="line">*  @param view  父view</span><br><span class="line">*  @param array BHBItem类型的集合</span><br><span class="line">*  @param block 回调</span><br><span class="line">*  @return pop视图</span><br><span class="line">*/</span></span><br><span class="line">+ (BHB_I<span class="built_in">NSTANCETYPE</span>)showToView:(<span class="built_in">UIView</span> *)view withItems:(<span class="built_in">NSArray</span> *)array andSelectBlock:(DidSelectItemBlock)block;</span><br></pre></td></tr></table></figure>
<p>hexo出点问题修复到下半夜啊（升级到3.0太蛋疼了），现在脑子晕晕的，明天还要去新公司入职，动画中还有很多细节我不能一一分享了，欢迎大家来搞我的<a href="https://github.com/bb-coder/BHBPopView" target="_blank" rel="external">Demo</a></p>
<p>good luck!</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">

    <div class="jiathis_style">
    <span class="jiathis_txt">分享到：</span>
    <a class="jiathis_button_qzone">QQ空间</a>
    <a class="jiathis_button_tsina">新浪微博</a>
    <a class="jiathis_button_tqq">腾讯微博</a>
    <a class="jiathis_button_weixin">微信</a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
    <a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<style>
    .jiathis_style div:first-child:not(.jiadiv_01) {
        width: auto !important;
        border: none !important;
    }
    .jiathis_style .jiadiv_01 {
        margin: 10px 0;
        border-radius: 4px;
        border: #e1e1e1 solid 1px;
    }
    .jiathis_style .jiadiv_01 div:first-child {
        display: none;
    }
    .jiathis_style .jiadiv_02 {
        padding: 7px 0 !important;
    }
    .jiathis_style .jiadiv_02 .jiatitle {
        width: 85px;
        border: none;
        height: auto;
        margin: 3px 10px;
        padding: 6px 10px;
        border-radius: 4px;
    }
    .jiathis_style .jiadiv_02 .jiatitle:hover {
        border: none;
    }
    .jiathis_style .jiadiv_02 .jiatitle:nth-child(even) {
        margin-left: 0;
    }
    .jiathis_style .jtico:hover {
        opacity: 1;
    }
    .jiathis_style .ckepopBottom,
    .jiathis_style .centerBottom {
        width: auto !important;
        padding: 5px;
        background: #f7f7f7;
    }
</style>



</div>

            
    
        <a href="http://bihongbo.com/2015/08/19/sinaAnimation/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://bihongbo.com/2015/08/19/sinaAnimation/">Comments</a>
    

        </footer>
    </div>
    
        
<nav id="article-nav">
    
        <a href="/2016/01/03/memoryGhostdrawRect/" id="article-nav-newer" class="article-nav-link-wrap">
            <strong class="article-nav-caption">Newer</strong>
            <div class="article-nav-title">
                
                    内存恶鬼drawRect
                
            </div>
        </a>
    
    
        <a href="/2015/07/16/copyProtocol/" id="article-nav-older" class="article-nav-link-wrap">
            <strong class="article-nav-caption">Older</strong>
            <div class="article-nav-title">copy协议解析</div>
        </a>
    
</nav>


    
</article>


    
    <section id="comments">
    
        
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>

    
    </section>

</section>
            
                <aside id="sidebar">
    
        
    <div class="widget-wrap">
        <h3 class="widget-title">recent</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2016/01/11/memoryGhostMore/" class="thumbnail">
    
    
        <span style="background-image:url(http://7xkdhe.com1.z0.glb.clouddn.com/boke201.jpeg)" alt="内存恶鬼drawRect（续:答疑篇）" class="thumbnail-image"></span>
    
</a>
                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/iOS/">iOS</a></p>
                            <p class="item-title"><a href="/2016/01/11/memoryGhostMore/" class="title">内存恶鬼drawRect（续:答疑篇）</a></p>
                            <p class="item-date"><time datetime="2016-01-10T19:00:10.000Z" itemprop="datePublished">2016-01-11</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2016/01/03/memoryGhostdrawRect/" class="thumbnail">
    
    
        <span style="background-image:url(http://7xkdhe.com1.z0.glb.clouddn.com/drawRect.gif)" alt="内存恶鬼drawRect" class="thumbnail-image"></span>
    
</a>
                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/iOS/">iOS</a></p>
                            <p class="item-title"><a href="/2016/01/03/memoryGhostdrawRect/" class="title">内存恶鬼drawRect</a></p>
                            <p class="item-date"><time datetime="2016-01-03T07:26:13.000Z" itemprop="datePublished">2016-01-03</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2015/08/19/sinaAnimation/" class="thumbnail">
    
    
        <span style="background-image:url(http://7xkdhe.com1.z0.glb.clouddn.com/sinaAnimation1.gif)" alt="一句代码添加新浪弹出框动画." class="thumbnail-image"></span>
    
</a>
                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/iOS/">iOS</a></p>
                            <p class="item-title"><a href="/2015/08/19/sinaAnimation/" class="title">一句代码添加新浪弹出框动画.</a></p>
                            <p class="item-date"><time datetime="2015-08-19T06:07:33.000Z" itemprop="datePublished">2015-08-19</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2015/07/16/copyProtocol/" class="thumbnail">
    
    
        <span style="background-image:url(http://7xkdhe.com1.z0.glb.clouddn.com/copyImage1.png)" alt="copy协议解析" class="thumbnail-image"></span>
    
</a>
                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/iOS/">iOS</a></p>
                            <p class="item-title"><a href="/2015/07/16/copyProtocol/" class="title">copy协议解析</a></p>
                            <p class="item-date"><time datetime="2015-07-16T05:27:04.000Z" itemprop="datePublished">2015-07-16</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2014/11/15/swift5/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>
                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/swift/">swift</a></p>
                            <p class="item-title"><a href="/2014/11/15/swift5/" class="title">Swift Section Five(对象与类)</a></p>
                            <p class="item-date"><time datetime="2014-11-15T08:22:03.000Z" itemprop="datePublished">2014-11-15</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">categories</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/swift/">swift</a><span class="category-list-count">6</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">archives</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">November 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">October 2014</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">September 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">August 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">July 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/06/">June 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/05/">May 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/03/">March 2013</a><span class="archive-list-count">2</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">tags</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/UILabel/">UILabel</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iOS/">iOS</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/swift/">swift</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/文字排版/">文字排版</a><span class="tag-list-count">1</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">tag cloud</h3>
        <div class="widget tagcloud">
            <a href="/tags/UILabel/" style="font-size: 10px;">UILabel</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/iOS/" style="font-size: 20px;">iOS</a> <a href="/tags/swift/" style="font-size: 15px;">swift</a> <a href="/tags/文字排版/" style="font-size: 10px;">文字排版</a>
        </div>
    </div>

    
        
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">links</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://hexo.io">Hexo</a>
                    </li>
                
            </ul>
        </div>
    </div>


    
    <div id="toTop" class="fa fa-chevron-up"></div>
</aside>
            
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2016 毕洪博<br>
            Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
        </div>
    </div>
</footer>
        
    
    <script>
    var disqus_shortname = 'bihongbo';
    
    
    var disqus_url = 'http://bihongbo.com/2015/08/19/sinaAnimation/';
    
    (function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>



    
        <script src="/vendor/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>
    


<!-- Custom Scripts -->
<script src="/js/main.js" type="text/javascript"></script>

    </div>
</body>
</html>
